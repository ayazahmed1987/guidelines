<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Laravel Ajax Pagination</title>
<style>
body {
font-family: "Segoe UI", sans-serif;
background-color: #f0f0f0;
padding: 30px;
color: #333;
} 

h1 {
text-align: center;
color: #6f42c1;
}

h2 {
margin-top: 40px;
color: #444;
border-bottom: 2px solid #ccc;
padding-bottom: 5px;
}

pre {
background-color: #1e1e1e;
color: #d4d4d4;
padding: 15px;
overflow-x: auto;
border-radius: 5px;
position: relative;
}

code {
font-family: Consolas, monospace;
white-space: pre-wrap;
}

.section {
margin-bottom: 40px;
}

.copy-btn {
position: absolute;
top: 10px;
right: 10px;
padding: 5px 10px;
font-size: 12px;
background-color: #28a745;
color: white;
border: none;
border-radius: 3px;
cursor: pointer;
}

.copy-btn:hover {
background-color: #218838;
}
</style>
</head>

<body>
<h1>üõ† Laravel Ajax Pagination</h1>

<div class="section">
<h2>üìö Filter File</h2>

<h4>üóÉÔ∏è Bulk Action Form</h4>
<pre><button class="copy-btn">Copy</button><code>
@if(Auth::user()->role == 40 || Auth::user()->role == 36)              
	<div class="row"><div class="col-md-12">               
	<form method='post' action='{{route("bulk_damage_action_form_submit")}}'>
	@csrf
	<input type='hidden' name='survey_ids' id='survey_ids' />
	<input type='hidden' name='bulk_action' id='bulk_action' />

	<input type='hidden' value='A' name='status' id='status'>
	@if(Auth::user()->role == 40)
	<input type='hidden' value='CEO' name='role' id='role'>
	@elseif(Auth::user()->role == 36)
	<input type='hidden' value='HRU' name='role' id='role'>
	@endif
	<input type='submit' name='action' value='Approved' class='btn btn-success'>
	<input type='submit' name='action' value='Reject' class='btn btn-danger'>
	<input type='submit' name='action' value='Hold' class='btn btn-primary'>
	</form></div>

	<div class="col-md-12 text-start">
	<button class="btn btn-danger bulkselection" data-action="1">Select All</button>
	<button class="btn btn-danger bulkselection" data-action="0">Deselect All</button>
	</div>
	</div> 
@endif
</code></pre>

<h4>üóÉÔ∏è Jquery Script</h4>
<pre><button class="copy-btn">Copy</button><code>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
$(document).ready(function() {
$('.select2').select2();    
    
	$('body').on('change', '.lot', function(e){
     e.preventDefault();
		var lot_id = $(e.target).find("option:selected").val();
		$.ajax({
              url: "{{ route('report.fetch_district_list') }}",
              type: 'POST',
              data: {lot_id: lot_id, _token: '{{csrf_token()}}'},
              beforeSend: function(){
                  $('.district_list').html('District list Processing...');
                  $('.tehsil_list').html('Tehsil list Processing...');
                  $('.uc_list').html('UC list Processing...');
              },
              success: function (response) {
                 $('.district_list').empty();				 
				 $('.district_list').html(response);
				 $('.tehsil_list').empty();				 
				 $('.tehsil_list').html('<select name="tehsil_id" class="form-control select2" id="tehsil_id"><option value="">Select Tehsil</option></select>');
                 $('.uc_list').empty();
                 $('.uc_list').html('<select name="uc_id" class="form-control select2" id="uc_id"><option value="">Select UC</option></select>');				 
				 $('.select2').select2();
				 //filter_data();
			  },
              error: function (response){$('.district_list').empty(); $('.tehsil_list').empty(); $('.uc_list').empty(); }
              });
    });
	
	$('body').on('change', '.district', function(e){
     e.preventDefault();
		var district_id = $(e.target).find("option:selected").val();
		$.ajax({
              url: "{{ route('report.fetch_tehsil_list') }}",
              type: 'POST',
              data: {district_id: district_id, _token: '{{csrf_token()}}'},
              beforeSend: function(){
                  $('.tehsil_list').html('Tehsil list Processing...');
                  $('.uc_list').html('UC list Processing...');
              },
              success: function (response) {
				 $('.tehsil_list').empty();				 
				 $('.tehsil_list').html(response);
                 $('.uc_list').empty();
                 $('.uc_list').html('<select name="uc_id" class="form-control select2" id="uc_id"><option value="">Select UC</option></select>');				 
				 $('.select2').select2();
				 filter_data();
			  },
              error: function (response){$('.tehsil_list').empty(); $('.uc_list').empty(); }
              });
    });
	
	$('body').on('change', '.tehsil', function(e){
     e.preventDefault();
		var tehsil_id = $(e.target).find("option:selected").val();
		$.ajax({
              url: "{{ route('report.fetch_uc_list') }}",
              type: 'POST',
              data: {tehsil_id: tehsil_id, _token: '{{csrf_token()}}'},
              beforeSend: function(){$('.uc_list').html('UC List Processing...');},
              success: function (response) {
				 $('.uc_list').empty(); 
				 $('.uc_list').html(response); 
				 $('.select2').select2();
				 filter_data();
			  },
              error: function (response){$('.uc_list').empty();}
              });
    });
	
	
	
	
});

$(document).ready(function(){	
    filter_data();
    function filter_data(currentpage, ayis_survey_id)
    {
    $('.filter_data').html('<div id="loading"></div>');

var action = 'fetch_data';
var bulkaction = $("#bulk_action").val();
var bulk_survey_id =  ayis_survey_id ?? '';
var ayis_page = currentpage ?? 1;

var start_date = $("#start_date").val();
var end_date = $("#end_date").val();       
var beneficiary_name = $("#beneficiary_name").val();
var b_reference_number = $("#b_reference_number").val();

//var colors = get_filter('color');

$.ajax({
type: 'POST',
data:{action:action, bulkaction:bulkaction, bulk_survey_id:bulk_survey_id, sorting:sorting, direction:direction, qty:qty, ayis_page:ayis_page, _token: '{{csrf_token()}}'},
url: "{{ route('report_survey_datalist_fetch_data') }}",
		   beforeSend: function(){$('.filter_data').html('<center><img src="{{ asset('images/loading.gif') }}" width="100" alt="Loader" /></center>');},
           success:function(data){
               
                  $('.filter_data').html(data);
              },
           error: function(data){console.log(data);}
  }); 
        
    }
	

function get_filter(class_name)
    {
        var filter = [];
        $('.'+class_name+':checked').each(function(){
            filter.push($(this).val());
        });
        return filter;
    }
    
            /*
            $(".color:checked").each(function(){
                colors.push($(this).val());
                colorName.push(this.name);
                $("#filter-item-color").html('<b>Color: </b>'+colorName);
            });
            */
    
    

    $('.common_selector').click(function(){
        filter_data();
    });
    
/*        
$('body').on('click', '.bulkselection', function(){
  //var action = $(this).attr('action');
  var action = $(this).data('action');
    $('#bulk_action').val(action);
    filter_data();
});
*/        
        
    
	
    $("#b_reference_number, #beneficiary_name, #survey_id_single, #primary_cnic, #proposed_cnic").on('keyup keydown', function() {
		filter_data();
    });
    


    $('body').on('change', '#sorting, #direction, #qty, #not_action,  #expired_cnic_status, #to_cnic_date, #from_cnic_date, #lot_id, #district_id, #tehsil_id, #uc_id, #gender, #disability, #vulnerable, #vulnerabilities, #review_by_mne, #landownership, #bank_ac_wise, #reconstruction_wise, #construction_type, #damage_type,  #start_date, #end_date, #form_status, #department, #status, #tranche, #socio_legal_status, #evidence_type, #status_of_land, #proposed_beneficiary, #pending_days', function(e){
            e.preventDefault();
            filter_data();
    });
      
    $('body').on('click','.pagination a',function(f){
        f.preventDefault();
        var url = $(this).attr('href');
        var currentpage = url.split('page=')[1];
        var ayis_survey_id = $("#survey_ids").val();
        
        filter_data(currentpage, ayis_survey_id);
    });
	
	
//Its Optional
==============
$('body').on('click', '.report_trail_btn', function(e){
        e.preventDefault();
        var survey_id = $(this).attr('survey_id');
        $('#reporttrail_modal').modal('show');
        
        $.ajax({
              url: "{{ route('report_trail_history') }}",
              type: 'GET',
              data:{_token: '{{csrf_token()}}', survey_id:survey_id},
              //dataType: 'JSON',
                  beforeSend: function(){$('#reporttrail_modal #modaldata').html('Processing...');},
                  success: function (response) {
                      $('#reporttrail_modal #modaldata').empty();
                      $('#reporttrail_modal #modaldata').html(response); 
                      
                  },
                   error: function (response){
                       $('#reporttrail_modal #modaldata').empty();
                       $('#reporttrail_modal #modaldata').html('Error 401');
                   }
        });
	
	
});	
	
	
	
	
	
$('body').on('click', '.bulkselection', function(e) {
    e.preventDefault();
    var action = $(this).data('action');
    if (action == 1) {
        var selectedValues = $('#survey_ids').val() ? $('#survey_ids').val().split(',').map(item => item.trim()) : [];

        $('.bulk_survey_id').each(function () {
            $(this).prop('checked', true); // Check all checkboxes
            var value = $(this).val();
            if (!selectedValues.includes(value)) {
                selectedValues.push(value);
            }
        });

        $('#survey_ids').val(selectedValues.join(','));
    } else {
        $('.bulk_survey_id').prop('checked', false); // Uncheck all checkboxes
        $('#survey_ids').val('');
    }
});	

var selectedValues = [];
$('body').on('change', '.bulk_survey_id', function(e){
  e.preventDefault();
  var value = $(this).val();
  
   if ($(this).is(':checked')) {
        selectedValues.push(value);
    } else {
        selectedValues = $.grep(selectedValues, function (item) {
            return item !== value;
        });
    }
    $('#survey_ids').val(selectedValues.join(','));
});


});

</code></pre>

</div>

<div class="section">
<h2>üìö Route And Controller</h2>
<h4>üóÉÔ∏è Route</h4>
<pre><button class="copy-btn">Copy</button><code>
Route::post('/bulk_damage_action_form_submit', 'bulk_damage_action_form_submit')->name('bulk_damage_action_form_submit');
</code></pre>
<h4>üóÉÔ∏è Controller Function</h4>
<pre><button class="copy-btn">Copy</button><code>
public function bulk_damage_action_form_submit(Request $request)
    {
     
          
     if(isset($request->ref_no_for_bulk)){
            $ref_no = explode(",", $request->ref_no_for_bulk);
            unset($ref_no[0]);
            $survey_ids=DB::table('survey_form')->whereIn('ref_no',$ref_no)->pluck('id');
     }else{
        $survey_ids = isset($request->survey_ids) ? explode(',', $request->survey_ids) : []; 
     }

    if(count($survey_ids)<=0){
        return redirect()->back()->with('error', 'Kindly select at least one survey form to proceed further!');
    }
    foreach ($survey_ids as $id) {
	}
	
	}


public function report_survey_datalist_fetch_data(Request $request, SurveyData $surveydata)
{
$filters = $request->all();
	    $page = $request->get('ayis_page');
        $qty = $request->get('qty');
        $custom_pagination_path = '';
       
        $sorting = $request->get('sorting');
        $order = $request->get('direction');

		$surveydata = $surveydata->with(['answers' => function ($q) {
            $q->select('survey_form_id','section_id','question_id','answer')->where(function ($query) {
                $query->whereIn('question_id', [250,251,645,646,648,649,650,651,653,654,655,663,664,666,668,2000,2242,2243,2304])->whereIn('section_id', [38,42,86,117]);
            });
        }, 'getuser', 'getlot', 'getdistrict', 'gettehsil', 'getuc','getformstatusold', 'getformstatushistory','getfirstbatch.getbatch','getverifybeneficairytranche','getverifybeneficairy']);


        if($request->filled('start_date') && $request->filled('end_date')){
            $start_date = Carbon::createFromFormat('Y-m-d', $request->get('start_date'))->startOfDay()->toDateTimeString();
            $end_date = Carbon::createFromFormat('Y-m-d', $request->get('end_date'))->endOfDay()->toDateTimeString();
			$surveydata->whereBetween('created_at', [$start_date, $end_date]);
        }
        
        
        if($request->filled('gender')){
			$surveydata->where('gender', $request->get('gender'));
        }
        
        
        
		if($request->filled('b_reference_number')){
			$surveydata->where('ref_no', $request->get('b_reference_number'));
        }
        
        if($request->filled('beneficiary_name')){
			$surveydata->where('beneficiary_details->beneficiary_name','like','%'.$request->get('beneficiary_name').'%');
        }
		
		if($request->filled('cnic')){
			$surveydata->where('cnic', $request->get('cnic'));
        }
		
		if ($request->filled('survey_id_single')) {
			$surveydata->where('id', $request->get('survey_id_single'));
        }
        
        


if($request->has('bulkaction') && $request->get('bulkaction') != null){
        
        if($request->get('bulkaction') == 1){
         $bulk_survey_id = $surveydata->pluck('id');   
        }elseif($request->get('bulkaction') == 0){
         $bulk_survey_id = '';   
        }

        }else{
        $bulk_survey_id = $request->get('bulk_survey_id');    
        }
        
        
        
        $surveydata->orderBy($sorting, $order);

$data = $surveydata->select('id', 'created_at','ref_no')->paginate($qty, ['*'], 'page', $page)->setPath($custom_pagination_path);
return view('dashboard.report.pagination_report_survey_datalist', compact('data','filters','bulk_survey_id'))->render();
}
</code></pre>
</div>

<div class="section">
<h2>üìö Pagination Datalist</h2>
<pre><button class="copy-btn">Copy</button><code>
@if(Auth::user()->role != 60)
{!! Form::open(array('route' => 'report_survey_datalist_export','method'=>'POST')) !!}                 
	{!! Form::hidden('allrequest', json_encode($filters)) !!}
	{!! Form::submit('Export Survey Report', array('name' => 'export', 'class' => 'btn btn-danger')); !!}
{!! Form::close() !!}
@endif

<?php 
$bulk_survey_id_list = explode(",", $bulk_survey_id);
?>

<th scope="col">Bulk Action</th>
@foreach($data->chunk(2) as $chunks)
@foreach($chunks as $item)
$isBulkChecked = in_array($item->id, $bulk_survey_id_list ?? []);
<td><input type="checkbox" value="{{ $item->id }}" class="bulk_survey_id" id="bulk_survey_id" {{ $isBulkChecked ? 'checked' : '' }} /></td>
@endforeach
@endforeach
</code></pre>
</div>

<div class="section">
<h2>üìö Export Datalist</h2>
<h4>üóÉÔ∏è Route</h4>
<pre><button class="copy-btn">Copy</button><code>
Route::post('report_survey_datalist_export', [App\Http\Controllers\ReportingController::class, 'report_survey_datalist_export'])->name('report_survey_datalist_export');
</code></pre>
<h4>üóÉÔ∏è Controller Function</h4>
<pre><button class="copy-btn">Copy</button><code>
public function report_survey_datalist_export(Request $request)
    {
        $allrequest = json_decode($request->allrequest, true); // Convert to associative array
        $surveydata = SurveyData::with(['answers' => function ($q) {
            $q->select('survey_form_id','section_id','question_id','answer')->where(function ($query) {
                $query->whereIn('question_id', [250,251,645,646,648,649,650,651,653,654,655,663,664,666,668,2304,2000])->whereIn('section_id', [38,42,86]);
            });
        }, 'getuser', 'getlot', 'getdistrict', 'gettehsil', 'getuc', 'getfirstbatch.getbatch','getverifybeneficairytranche','getverifybeneficairy']);
        
        // Apply filters only if the values exist
        if (!empty($allrequest['start_date']) && !empty($allrequest['end_date'])) {
        $start_date = Carbon::createFromFormat('Y-m-d', $allrequest['start_date'])->startOfDay()->toDateTimeString();
        $end_date = Carbon::createFromFormat('Y-m-d', $allrequest['end_date'])->endOfDay()->toDateTimeString();
        $surveydata->whereBetween('created_at', [$start_date, $end_date]);
        }


		if(!empty($allrequest['b_reference_number'])) {
			$surveydata->where('ref_no', $allrequest['b_reference_number']);
        }
        
        if(!empty($allrequest['beneficiary_name'])) {
            $beneficiary_name = $allrequest['beneficiary_name'];
			$surveydata->where('beneficiary_details->beneficiary_name','like','%'.$beneficiary_name.'%');
        }
		
    
	$surveydata->select('id', 'created_at', 'ref_no')->orderBy('id', 'asc'); 
    //$test = $surveydata->select(['id', 'user_id', 'ref_no', 'status', 'm_role_id', 'created_at'])->get()->chunk(1000);
    //dd($test);
    
        
    //After Filter Generate Report
    $fileName = 'survey_master_report_export_' . date('YmdHis') . '.csv';
    $headers = [
        "Content-Type" => "text/csv",
        "Content-Disposition" => "attachment; filename=$fileName",
    ];

        $callback = function () use ($surveydata) {
        $file = fopen('php://output', 'w');

        // Write CSV Header
        fputcsv($file, ['SID','Date','Ref No',]);

        // Stream data in chunks to prevent memory issues
        $surveydata->chunk(1000, function ($records) use ($file) {
                
                foreach ($records as $item) {

                    fputcsv($file, [
                        $item->id,
                        Carbon::parse($item->created_at)->format('d-m-Y'),
                        $item->ref_no ?? ''
                        
                    ]);
                }
                // Flush output buffer after each chunk
                flush();
            });

        fclose($file);
    };

    return response()->stream($callback, 200, $headers);

        
    }
</code></pre>
</div>


<div class="section">
<h2>üìö Session Messages</h2>

<h4>üóÉÔ∏è Success</h4>
<pre><button class="copy-btn">Copy</button><code>
@if(session('success'))
        <script>

            const Toast = Swal.mixin({
                toast: true,
                position: "top-end",
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                didOpen: (toast) => {
                    toast.onmouseenter = Swal.stopTimer;
                    toast.onmouseleave = Swal.resumeTimer;
                }
            });
            Toast.fire({
                icon: "success",
                title: "{{ session('success') }}"
            });
        </script>
    @endif
</code></pre>
<h4>üóÉÔ∏è Error</h4>
<pre><button class="copy-btn">Copy</button><code>
@if(session('error'))
        <script>
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: "{{ session('error') }}",
                toast: true,         // This enables the toast mode
                position: 'top-end', // Position of the toast
                showConfirmButton: false, // Hides the confirm button
                timer: 3000          // Time to show the toast in milliseconds
            });
        </script>
    @endif
</code></pre>
</div> 


<script>
// Copy button functionality
document.querySelectorAll(".copy-btn").forEach((button) => {
button.addEventListener("click", () => {
const code = button.nextElementSibling.innerText;
navigator.clipboard.writeText(code).then(() => {
button.innerText = "Copied!";
setTimeout(() => (button.innerText = "Copy"), 1500);
});
});
});
</script>
</body>
</html>